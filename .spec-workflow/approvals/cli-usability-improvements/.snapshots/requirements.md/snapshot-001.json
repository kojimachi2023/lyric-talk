{
  "id": "snapshot_1766210861526_o6h8mk3da",
  "approvalId": "approval_1766210861516_ydj62vxkz",
  "approvalTitle": "要件定義: cli-usability-improvements",
  "version": 1,
  "timestamp": "2025-12-20T06:07:41.526Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Requirements Document\n\n## Introduction\n\n本specは、`lyric-talk` CLI のユーザービリティを改善し、ユーザーが **ID（`lyrics_corpus_id` / `run_id`）を事前にDBから調べないと操作できない** 現状を解消する。\n\n具体的には、\n\n- `match` 実行時に `corpus_id` が省略された場合、利用可能な歌詞コーパスを一覧表示し、ユーザーに選択させる\n- `query` 実行時に `run_id` が省略された場合、利用可能なマッチ実行履歴を一覧表示し、ユーザーに選択させる\n- そのために必要な「一覧/参照/削除」などのCRUDを、Domain Repository を利用する **Application UseCase** として追加する\n- CLI の実装を **Typer**（型安全・補完/ヘルプ・入力バリデーション）と **Rich**（一覧表示/プロンプト/整形）で刷新し、保守性と可読性を上げる\n\nを達成する。\n\n## Alignment with Product Vision\n\n`lyric-talk` のプロダクト原則（steering `product.md`）に対して、以下の点で整合する。\n\n- **Explainability First**: 選択候補（コーパス/実行履歴）の概要を可視化し、「何を選んだか」「なぜそのデータを使ったか」を追える\n- **Reproducibility & Configurability**: 明示的な `corpus_id` / `run_id` 指定も可能にしたうえで、省略時の選択を決定論的（ソート順やデフォルト選択ルール）にする\n- **CLI中心のワークフロー**: 利用者がDBを直接開かずに、CLIだけで完結して操作できる\n\n## Requirements\n\n### Requirement 1: `match` の `corpus_id` 省略時に一覧表示→選択\n\n**User Story:** CLIユーザーとして、`match` 実行時に `corpus_id` を知らなくても、登録済みコーパスの一覧から選択してマッチングできるようにしたい。そうすれば、毎回DBを開いてIDを確認する手間がなくなる。\n\n#### Acceptance Criteria\n\n1. WHEN ユーザーが `lyric-talk match` を `corpus_id` なしで実行した場合 THEN システム SHALL 登録済み歌詞コーパスの一覧（概要）を表示する\n2. WHEN 一覧が表示された後 THEN システム SHALL ユーザーにコーパス選択を促し、選択されたコーパスIDを `MatchTextUseCase.execute(input_text, lyrics_corpus_id)` に渡して実行する\n3. IF 登録済み歌詞コーパスが0件 THEN システム SHALL 「先に `register` が必要」であることを明確に表示し、非ゼロ終了コードで終了する\n4. IF 登録済み歌詞コーパスが1件 THEN システム SHALL そのコーパスをデフォルト選択して続行できる（ただしユーザーに選択されたことが分かる表示を行う）\n5. WHEN ユーザーが明示的に `corpus_id`（または同等のオプション）を指定して `match` を実行した場合 THEN システム SHALL 一覧表示/選択をスキップして直接マッチングを実行する\n\n**Notes (Scope):** 一覧表示に含める概要情報は、少なくとも `corpus_id` とユーザーが識別しやすい識別子（例: title、登録日時、トークン数等）のいずれかを含むこと。\n\n### Requirement 2: `query` の `run_id` 省略時に一覧表示→選択\n\n**User Story:** CLIユーザーとして、`query` 実行時に `run_id` を知らなくても、過去の実行履歴の一覧から選択して結果を参照できるようにしたい。そうすれば、IDを控えていなくても結果に辿り着ける。\n\n#### Acceptance Criteria\n\n1. WHEN ユーザーが `lyric-talk query` を `run_id` なしで実行した場合 THEN システム SHALL 登録済みマッチ実行履歴（`run_id` の一覧）を概要つきで表示する\n2. WHEN 一覧が表示された後 THEN システム SHALL ユーザーに実行履歴の選択を促し、選択された `run_id` を `QueryResultsUseCase.execute(run_id)` に渡して実行する\n3. IF 実行履歴が0件 THEN システム SHALL 「先に `match` が必要」であることを明確に表示し、非ゼロ終了コードで終了する\n4. WHEN ユーザーが明示的に `run_id`（または同等のオプション）を指定して `query` を実行した場合 THEN システム SHALL 一覧表示/選択をスキップして直接照会を実行する\n\n**Notes (Scope):** 一覧表示に含める概要情報は、少なくとも `run_id` と `timestamp`、および識別しやすい付随情報（例: `lyrics_corpus_id`、入力文の先頭N文字、マッチ件数、設定など）のいずれかを含むこと。\n\n### Requirement 3: CLIから利用できる「一覧/参照/削除」用UseCase（CRUDの一部）を追加\n\n**User Story:** 開発者として、CLIのためのDB操作ロジックがCLI層に散らばらず、Application層のUseCaseとして整理されてほしい。そうすれば、テストしやすく拡張しやすい。\n\n#### Acceptance Criteria\n\n1. WHEN CLIがコーパス一覧を表示する必要がある場合 THEN システム SHALL Application層に追加されたUseCase経由で取得する（Domain Repository へ直接アクセスしない）\n2. WHEN CLIが実行履歴一覧を表示する必要がある場合 THEN システム SHALL Application層に追加されたUseCase経由で取得する（Domain Repository へ直接アクセスしない）\n3. WHEN CLIがコーパス/実行履歴の参照・削除を行う場合 THEN システム SHALL それぞれ対応するUseCaseを提供する（少なくとも一覧/参照は必須、削除は最小限のスコープでよい）\n4. WHEN UseCaseがデータを返す場合 THEN システム SHALL CLI表示に必要な「概要情報」を返せる（例: DTOの導入、またはDomainモデルからの情報抽出）\n\n### Requirement 4: Typer + Rich によるCLI刷新（型安全性・可読性・UX）\n\n**User Story:** CLIユーザーとして、ヘルプやエラーメッセージが分かりやすく、候補一覧が見やすく、入力ミスが減るCLIを使いたい。\n\n#### Acceptance Criteria\n\n1. WHEN ユーザーが `--help` を実行した場合 THEN システム SHALL コマンド/オプション/引数の説明を分かりやすく提示する\n2. WHEN ユーザーが不正な値（例: 存在しない `corpus_id` / `run_id`）を指定した場合 THEN システム SHALL 何が不正か・どう直すかを示すエラーメッセージを表示する\n3. WHEN 一覧表示（コーパス/実行履歴）を行う場合 THEN システム SHALL Richのテーブル等で視認性高く表示する\n4. WHEN ユーザー選択が必要な場合 THEN システム SHALL Rich/Typerのプロンプト等で、選択肢が明確な対話的入力を提供する\n5. WHEN CLIをスクリプト/CI等の非対話環境で実行する場合 THEN システム SHALL 対話入力が不要になる経路（ID明示指定）を提供し、対話が必要な状況では明確なエラーを返せる\n\n### Requirement 5: 既存利用との互換性・移行容易性\n\n**User Story:** 既存ユーザー/既存テストとして、これまでのコマンド利用方法が大きく壊れずに改善を取り込めてほしい。\n\n#### Acceptance Criteria\n\n1. WHEN ユーザーが従来通り `match` に `corpus_id` を与えて実行する場合 THEN システム SHALL 既存の機能要件（マッチング実行と `run_id` 出力）を維持する\n2. WHEN ユーザーが従来通り `query` に `run_id` を与えて実行する場合 THEN システム SHALL 既存の機能要件（結果の表示/出力）を維持する\n3. WHEN CLI実装を刷新する場合 THEN システム SHALL 既存のテスト戦略（pytest + ruff、Onion/DDDの依存方向）に従い、テストが追加/更新される\n\n## Non-Functional Requirements\n\n### Code Architecture and Modularity\n\n- **Onion Architectureの依存方向を維持**: Interface → Application → Domain、InfrastructureはDomainへ依存しない\n- **Single Responsibility**: 一覧取得/削除などのI/OはUseCaseに寄せ、CLIは入出力整形と呼び出しに集中する\n- **Clear Interfaces**: CLI表示用のDTO（概要）を導入する場合、Domainモデルの漏洩を避ける/最小化する\n- **Testability**: 新規UseCaseとCLIの主要分岐（省略時一覧/選択、0件、1件、明示指定）をテスト可能にする\n\n### Performance\n\n- 一覧表示は「概要情報」の取得を基本とし、不要な詳細ロード（例: 全トークン展開）を避ける\n- 表示件数が多い場合に備え、ソート（例: 新しい順）や件数制限（例: 直近N件）を検討可能にする\n\n### Security\n\n- すべてローカル完結（外部送信なし）を維持する\n- ファイル入力の扱いは既存と同等の安全性（パス存在チェック、例外処理）を維持する\n\n### Reliability\n\n- 省略時の候補提示・ソート・デフォルト選択ルールは明確で、再現性がある\n- 例外時は非ゼロ終了コードで終了し、原因をユーザーに示す\n\n### Usability\n\n- 一覧表示は識別しやすい列（ID・タイトル/日時など）を持つ\n- 対話選択は「番号選択」「ID入力」など誤入力しにくい形式を採用する\n- 非対話環境向けに、対話を回避する明示指定ルートを必ず提供する\n",
  "fileStats": {
    "size": 9421,
    "lines": 115,
    "lastModified": "2025-12-20T06:07:31.634Z"
  },
  "comments": []
}